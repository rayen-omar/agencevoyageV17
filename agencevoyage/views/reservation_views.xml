<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue Formulaire Réservation -->
    <record id="view_reservation_form" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.form</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <form string="Réservation">
                <header>
                    <button name="action_confirmer" string="Confirmer la Réservation" 
                            type="object" 
                            class="oe_highlight"
                            invisible="statut == 'confirmee' or statut == 'annulee' or statut == 'terminee'"
                            confirm="Êtes-vous sûr de vouloir confirmer cette réservation ?"/>
                    <button name="action_annuler" string="Annuler la Réservation" 
                            type="object" 
                            invisible="statut == 'annulee' or statut == 'terminee'"
                            confirm="Êtes-vous sûr de vouloir annuler cette réservation ?"/>
                    <button name="action_envoyer_rappel_paiement" string="Envoyer Rappel Paiement" 
                            type="object" 
                            invisible="reste_a_payer &lt;= 0 or not client_id.email"
                            title="Envoyer un email de rappel de paiement au client"/>
                    <field name="statut" widget="statusbar" statusbar_visible="en_attente,confirmee,terminee"/>
                </header>
                <style>
                    .o_form_view .o_field_widget input,
                    .o_form_view .o_field_widget textarea,
                    .o_form_view .o_field_widget select {
                        border: 2px solid #71639E !important;
                        border-radius: 4px;
                        padding: 8px 12px;
                        transition: all 0.3s ease;
                    }
                    
                    .o_form_view .o_field_widget input:hover,
                    .o_form_view .o_field_widget textarea:hover,
                    .o_form_view .o_field_widget select:hover {
                        border-color: #8B7BB8 !important;
                        box-shadow: 0 0 0 3px rgba(113, 99, 158, 0.1);
                    }
                    
                    .o_form_view .o_field_widget input:focus,
                    .o_form_view .o_field_widget textarea:focus,
                    .o_form_view .o_field_widget select:focus {
                        border-color: #71639E !important;
                        box-shadow: 0 0 0 3px rgba(113, 99, 158, 0.2);
                        outline: none;
                    }
                </style>
                <sheet>
                    <div class="oe_title">
                        <label for="name" string="Réservation"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group>
                            <field name="date_reservation" required="1"/>
                            <field name="statut" required="1"/>
                            <field name="voyage_id" required="1"/>
                            <field name="client_id" required="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <!-- Voyageurs -->
                        <page string="Voyageurs">
                            <group>
                                <group string="Résumé">
                                    <field name="nombre_adultes" readonly="1"/>
                                    <field name="nombre_enfants" readonly="1"/>
                                    <field name="total_personnes" readonly="1"/>
                                </group>
                            </group>
                            
                            <field name="voyageur_ids" nolabel="1">
                                <tree string="Liste des voyageurs" create="1" delete="1">
                                    <field name="nom"/>
                                    <field name="type_voyageur"/>
                                    <field name="age"/>
                                </tree>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="nom"/>
                                            <field name="type_voyageur"/>
                                            <field name="age"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>

                        <!-- Chambres -->
                        <page string="Chambres">
                            <field name="chambre_ids" nolabel="1">
                                <tree string="Chambres" create="1" delete="1">
                                    <field name="type_chambre"/>
                                    <field name="nombre_chambres"/>
                                    <field name="nombre_nuits"/>
                                    <field name="prix_nuit"/>
                                    <field name="total_chambre" readonly="1" sum="Total"/>
                                </tree>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="type_chambre"/>
                                            <field name="nombre_chambres"/>
                                            <field name="nombre_nuits"/>
                                            <field name="prix_nuit"/>
                                            <field name="total_chambre" readonly="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>

                        <!-- Calcul des prix -->
                        <page string="Calcul des prix">
                            <group>
                                <group string="Transport">
                                    <field name="prix_transport" readonly="1"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Calculé automatiquement : (Prix adulte × Adultes) + (Prix enfant × Enfants)
                                        </p>
                                    </div>
                                </group>
                                
                                <group string="Hôtel">
                                    <field name="prix_hotel" readonly="1"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Basé sur les chambres réservées
                                        </p>
                                    </div>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Restauration">
                                    <field name="prix_restauration" readonly="1"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Basé sur les repas du voyage
                                        </p>
                                    </div>
                                </group>
                                
                                <group string="Guide">
                                    <field name="prix_guide" readonly="1"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Basé sur les guides du voyage
                                        </p>
                                    </div>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Équipement">
                                    <field name="prix_equipement" readonly="1"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Basé sur les équipements du voyage
                                        </p>
                                    </div>
                                </group>
                                
                                <group string="Suppléments">
                                    <field name="supplement_chambre"/>
                                    <div colspan="2">
                                        <p class="text-muted">
                                            Supplément pour chambres supplémentaires
                                        </p>
                                    </div>
                                </group>
                            </group>
                            
                            <group class="oe_subtotal_footer oe_right">
                                <group string="Total">
                                    <field name="montant_total" readonly="1" class="oe_subtotal_footer_separator"/>
                                </group>
                            </group>
                        </page>
                        
                        <!-- Paiements -->
                        <page string="Paiements">
                            <field name="paiement_ids" nolabel="1">
                                <tree string="Paiements" create="1" delete="1">
                                    <field name="name"/>
                                    <field name="date_paiement"/>
                                    <field name="type_paiement_client"/>
                                    <field name="montant" sum="Total"/>
                                    <field name="mode_paiement"/>
                                    <field name="statut"/>
                                </tree>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="date_paiement"/>
                                            <field name="type_paiement_client"/>
                                            <field name="montant"/>
                                            <field name="mode_paiement"/>
                                            <field name="reference_bancaire"/>
                                            <field name="statut"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                            
                            <group class="oe_subtotal_footer oe_right">
                                <group string="Résumé Financier">
                                    <field name="montant_total" readonly="1"/>
                                    <field name="deja_paye" readonly="1"/>
                                    <field name="reste_a_payer" readonly="1"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                    
                    <group>
                        <group>
                            <field name="email_confirme"/>
                        </group>
                    </group>
                </sheet>

                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Vue Liste Réservation -->
    <record id="view_reservation_tree" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.tree</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <tree string="Réservations" 
                  decoration-info="statut == 'en_attente'" 
                  decoration-warning="statut == 'confirmee'" 
                  decoration-success="statut == 'terminee'" 
                  decoration-muted="statut == 'annulee'"
                  default_order="date_reservation desc">
                <field name="name"/>
                <field name="date_reservation"/>
                <field name="statut" widget="badge" 
                       decoration-info="statut == 'en_attente'" 
                       decoration-warning="statut == 'confirmee'" 
                       decoration-success="statut == 'terminee'" 
                       decoration-danger="statut == 'annulee'"/>
                <field name="voyage_id"/>
                <field name="client_id"/>
                <field name="total_personnes" string="Personnes"/>
                <field name="montant_total" sum="Total" widget="monetary"/>
                <field name="reste_a_payer" sum="Reste à payer" widget="monetary" 
                       decoration-danger="reste_a_payer > 0" 
                       decoration-success="reste_a_payer == 0"/>
            </tree>
        </field>
    </record>

    <!-- Vue Recherche Réservation -->
    <record id="view_reservation_search" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.search</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <search string="Rechercher une Réservation">
                <field name="name" string="Numéro"/>
                <field name="voyage_id"/>
                <field name="client_id"/>
                <field name="date_reservation"/>
                
                <filter string="En attente" name="en_attente" domain="[('statut', '=', 'en_attente')]"/>
                <filter string="Confirmée" name="confirmee" domain="[('statut', '=', 'confirmee')]"/>
                <filter string="Terminée" name="terminee" domain="[('statut', '=', 'terminee')]"/>
                <filter string="Annulée" name="annulee" domain="[('statut', '=', 'annulee')]"/>
                
                <separator/>
                <filter string="Avec reste à payer" name="reste_a_payer" domain="[('reste_a_payer', '&gt;', 0)]"/>
                <filter string="Payé intégralement" name="paye_integralement" domain="[('reste_a_payer', '=', 0)]"/>
                
                <group expand="0" string="Grouper par">
                    <filter string="Statut" name="group_statut" context="{'group_by': 'statut'}"/>
                    <filter string="Voyage" name="group_voyage" context="{'group_by': 'voyage_id'}"/>
                    <filter string="Client" name="group_client" context="{'group_by': 'client_id'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'date_reservation'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Vue Kanban Réservation -->
    <record id="view_reservation_kanban" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.kanban</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <kanban default_group_by="statut" class="o_kanban_dashboard">
                <field name="id"/>
                <field name="name"/>
                <field name="date_reservation"/>
                <field name="statut"/>
                <field name="voyage_id"/>
                <field name="client_id"/>
                <field name="montant_total"/>
                <field name="reste_a_payer"/>
                <field name="total_personnes"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <div class="o_kanban_record_subtitle">
                                            <field name="client_id"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div>
                                        <i class="fa fa-plane"/> <field name="voyage_id"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-calendar"/> <field name="date_reservation"/>
                                    </div>
                                    <div>
                                        <i class="fa fa-users"/> <field name="total_personnes"/> personnes
                                    </div>
                                    <div class="mt-2">
                                        <strong>Total: <field name="montant_total" widget="monetary"/></strong>
                                    </div>
                                    <div t-if="record.reste_a_payer.raw_value > 0" class="text-warning">
                                        <i class="fa fa-exclamation-triangle"/> Reste: <field name="reste_a_payer" widget="monetary"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Graphique Réservation -->
    <record id="view_reservation_graph" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.graph</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <graph string="Statistiques des Réservations" type="bar">
                <field name="date_reservation" type="row" interval="month"/>
                <field name="montant_total" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Vue Pivot Réservation -->
    <record id="view_reservation_pivot" model="ir.ui.view">
        <field name="name">agencevoyage.reservation.pivot</field>
        <field name="model">agencevoyage.reservation</field>
        <field name="arch" type="xml">
            <pivot string="Analyse des Réservations">
                <field name="date_reservation" type="row" interval="month"/>
                <field name="voyage_id" type="col"/>
                <field name="montant_total" type="measure"/>
                <field name="total_personnes" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Action Réservation -->
    <record id="action_reservation" model="ir.actions.act_window">
        <field name="name">Réservations</field>
        <field name="res_model">agencevoyage.reservation</field>
        <field name="view_mode">kanban,tree,form,graph,pivot</field>
        <field name="search_view_id" ref="view_reservation_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer votre première réservation
            </p>
            <p>
                Gérez les réservations de vos clients pour chaque voyage.
            </p>
        </field>
    </record>

    <!-- Actions d'export pour Réservation -->
    <record id="action_reservation_export_excel" model="ir.actions.server">
        <field name="name">Exporter en Excel</field>
        <field name="model_id" ref="model_agencevoyage_reservation"/>
        <field name="binding_model_id" ref="model_agencevoyage_reservation"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_export_excel()
        </field>
    </record>

    <record id="action_reservation_export_csv" model="ir.actions.server">
        <field name="name">Exporter en CSV</field>
        <field name="model_id" ref="model_agencevoyage_reservation"/>
        <field name="binding_model_id" ref="model_agencevoyage_reservation"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_export_csv()
        </field>
    </record>
</odoo>
